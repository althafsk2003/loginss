@model WebApplication4.Models.SubHODEventReviewViewModel

@{
    Layout = "~/Views/Shared/_SubHODLayout.cshtml";
}

<h2 class="mb-4 text-center text-primary">Review Event Requests</h2>

<div class="container">
    @using (Html.BeginForm("ViewEventRequests", "SubHOD", FormMethod.Post))
    {
        <div class="form-inline justify-content-center mb-4">
            <label for="SelectedClubId" class="mr-2 font-weight-bold">Select Club:</label>
            @Html.DropDownListFor(m => m.SelectedClubId, Model.ActiveClubs, "Select a club", new
            {
                @class = "form-control form-control-sm w-auto",
                onchange = "this.form.submit();"
            })
        </div>
    }

    @if (Model.Events != null && Model.Events.Any())
    {
        <div id="eventCarousel" class="carousel slide" data-ride="carousel">
            <div class="carousel-inner">
                @for (int i = 0; i < Model.Events.Count; i++)
                {
                    var evt = Model.Events[i];
                    <div class="carousel-item @(i == 0 ? "active" : "")">
                        <div class="card mx-auto mt-3 shadow-sm" style="width: 38rem; border-radius: 16px;">
                            <img src="@Url.Content(evt.EventPoster ?? "~/Content/Images/no-poster.png")"
                                 class="card-img-top"
                                 alt="Event Poster"
                                 style="max-height: 250px; object-fit: cover; border-top-left-radius: 16px; border-top-right-radius: 16px;" />
                            <div class="card-body">
                                <h5 class="card-title text-primary">@evt.EventName</h5>
                                <p class="card-text">
                                    <span class="short-desc">
                                        @(evt.EventDescription?.Length > 150
                                            ? evt.EventDescription.Substring(0, 150) + "..."
                                            : evt.EventDescription)
                                    </span>
                                    <span class="full-desc d-none">@evt.EventDescription</span>
                                    @if (!string.IsNullOrEmpty(evt.EventDescription) && evt.EventDescription.Length > 150)
                                    {
                                        <a href="javascript:void(0);" class="toggle-desc text-primary ml-1">See more</a>
                                    }
                                </p>
                                <p><strong>Start:</strong> @evt.EventStartDateAndTime.ToString("dd MMM yyyy")</p>
                                <p><strong>End:</strong> @evt.EventEndDateAndTime.ToString("dd MMM yyyy")</p>
                                <p>
                                    <strong>Budget Document:</strong>
                                    @if (!string.IsNullOrEmpty(evt.BudgetDocumentPath))
                                    {
                                        <a href="@Url.Content(evt.BudgetDocumentPath)" target="_blank">Download</a>
                                    }
                                    else
                                    {
                                        <span>No document uploaded</span>
                                    }
                                </p>

                                <div class="mt-3">
                                    @using (Html.BeginForm("ForwardToDirectorPost", "SubHOD", FormMethod.Post, new { @class = "d-inline", onsubmit = "return confirmForward();" }))
                                    {
                                        @Html.AntiForgeryToken()
                                        @Html.Hidden("token", evt.EventID)
                                        <button type="submit" class="btn btn-sm btn-success">Forward to Director</button>
                                    }


                                    <button type="button" class="btn btn-sm btn-danger ml-2" onclick="showRejectModal(@evt.EventID)">Reject with Reason</button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <a class="carousel-control-prev" href="#eventCarousel" role="button" data-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="sr-only">Previous</span>
            </a>
            <a class="carousel-control-next" href="#eventCarousel" role="button" data-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="sr-only">Next</span>
            </a>
        </div>
    }
    else if (Model.SelectedClubId != 0)
    {
        <div class="alert alert-info text-center">No events found for this club.</div>
    }
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" role="dialog" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="rejectModalLabel">Reject Event</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                @Html.AntiForgeryToken()
                <input type="hidden" id="rejectEventId" name="token"/>
                <div class="form-group">
                    <label for="RejectReason">Reason for rejection:</label>
                    <textarea id="RejectReason" class="form-control" required></textarea>
                    <small id="rejectError" class="text-danger"></small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="rejectSubmitBtn" class="btn btn-danger">Reject</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
function showRejectModal(eventId) {
    $('#rejectEventId').val(eventId);  // This is numeric EventID
    $('#RejectReason').val('');
    $('#rejectError').text('');
    $('#rejectModal').modal('show');
}

$(document).ready(function () {
    $('#rejectSubmitBtn').click(function () {
        var eventId = $('#rejectEventId').val();
        var reason = $('#RejectReason').val();
        var antiForgeryToken = $('input[name="__RequestVerificationToken"]').val();

        if (!reason) {
            $('#rejectError').text('Please provide a reason.');
            return;
        }

        // Add confirmation
        if (!confirm("Are you sure you want to reject this event?")) {
            return;
        }

        $.ajax({
            url: '@Url.Action("RejectEvent", "SubHOD")',
            type: 'POST',
            data: {
                __RequestVerificationToken: antiForgeryToken,
                eventId: eventId,
                rejectionReason: reason
            },
            success: function (res) {
                if (res.success) {
                    $('#rejectModal').modal('hide');
                    alert(res.message);
                    location.reload();
                } else {
                    $('#rejectError').text(res.message);
                }
            },
            error: function () {
                $('#rejectError').text('An unexpected error occurred.');
            }
        });
    });
});

// Forward confirmation
function confirmForward() {
    return confirm("Are you sure you want to forward this event to the Director?");
}

    </script>

}

@section Styles {
    <style>
        html, body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            background-color: #f5f8fa;
        }

        h2 {
            font-size: 34px;
            font-weight: 600;
        }

        .form-inline label {
            font-size: 20px;
        }

        .form-inline .form-control-sm {
            width: 220px;
        }

        .card {
            border-radius: 16px;
            border: 1px solid #dee2e6;
            margin: 0 auto;
        }

        .carousel-control-prev,
        .carousel-control-next {
            width: 40px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 1;
        }

        .carousel-control-prev {
            left: 150px;
        }

        .carousel-control-next {
            right: 150px;
        }

        .carousel-control-prev-icon,
        .carousel-control-next-icon {
            background-color: #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            background-size: 50% 50%;
            background-repeat: no-repeat;
            background-position: center;
        }

        .carousel-inner {
            padding: 0;
        }

        .container {
            padding-left: 0;
            padding-right: 0;
        }

        .toggle-desc {
            cursor: pointer;
            font-weight: 500;
        }
    </style>



}
